<!DOCTYPE>
<html>
<head>
	<title>Erebyte</title>
	
	<script src="//ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src="/res/hogan.js"></script>

	<script src="./res/templates.js"></script>

	<link rel="stylesheet" type="text/css" href="/res/style.css">
	<link rel="stylesheet" type="text/css" href="/res/play.css">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

	<script type="text/javascript">
		//-=-=-=-=-=-=- Functions -=-=-=-=-=-=-//
		$.urlParam = function(name){
			// seperates and returns url parms
			var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
			if (results==null){
				return null;
			}
			else{
				return results[1] || 0;
			}
		}

		'use strict'; // from: https://codepad.co/snippet/zRykJud8
		String.prototype.capitalize = function() {
			return this.charAt(0).toUpperCase() + this.slice(1);
		}

		String.prototype.titleize = function() {
			var string_array = this.replaceAll('_',' ').split(' ');
			string_array = string_array.map(function(str) {
				return str.capitalize(); 
			});
			return string_array.join(' ');
		}

		String.prototype.replaceAll = function(s, r) {
			// a simple replace all function (sorry im used to python)
			return this.split(s).join(r);
		}

		//-=-=- Embedding Code -=-=-//
		//const
		var game_id = $.urlParam('g');
		var game_title = game_id.titleize();
		//gobals
		var base_url;

		// callbacks
		$(document).ready(function () {
			$('title').html("Erebyte - "+game_title) // set title
			base_url = "./games/"+game_id;
			$.getJSON(base_url+"/manifest.json", function(json_data) {
				// fills template
				var template = Hogan.compile($("#game").html());
				var html = template.render(json_data.conf);
				$("#game").html(html);
				$('#game_footer').css('display', 'block'); // show info +ani
				//-=- local functions -=-//
				var load_scripts = function () {
					// Loads all scripts in manifest
					for (var i=0; i<json_data.scripts.length; i++) {
						var url = json_data.scripts[i].replace("./", base_url+"/");
						var count = i;
						$.getScript(url)
						.always(function () {
							if (count == json_data.scripts.length-1) {
								$("#loader").css('display', 'none'); // clear loader
							}
						}).fail(function () {
							console.log('failed to load script');
						});
					}
				}
				// game embedding code
				if (json_data.conf.embeded == true) {
					if (json_data.conf.enable_p5 == true) {
						// if p5 is enabled
						$.getScript("//cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.3/p5.js", load_scripts);
					}else {
						load_scripts();
					}
				}else {
					// if game is in seperate window (not embeded)
					var img_src = json_data.conf.img_src || "http://placehold.it/720x250"
					var htm = '<a href="'+base_url+'"><img src="'+img_src+'" alt="'+json_data.conf.img_alt+'"></a>';
					$("#game_container").html(htm);
					$("#loader").css('display', 'none'); // clear loader
				}
			}).fail(function (jqxhr, textStatus, error) {
				//-=-=-=- If Fails to find and load a game -=-=-=-//
				// var err = textStatus + ", " + error;
				// console.log( "Request Failed: " + err );
				// ^^ Log Error ^^ //
				var responce = {}; // fake responce data
				responce.title = game_title + " (Not Found)"
				responce.desc = "If you are seeing this message that means you are trying to access a game that does not exist. If you believe this to be a problem you can contact the site admin through some means... probably in the about section... so... yeah. <br/><br/>Bye (^.^)/"
				var img_htm = '<img src="http://placehold.it/720x250"/>'
				var template = Hogan.compile(img_htm + $("#game").html());
				var html = template.render(responce);
				$("#game").html(html); // fill template
				$("#loader").css('display', 'none'); // clear loader
				$('#game_footer').css('display', 'block'); // show info
			});
		});
	</script>
</head>
<body>

<div id="header"></div>

<div id="game">
	<div id="loader"></div>
	<div id="game_container"></div>

	<div style='display:none' id="game_footer" class='animate-top'>
		<div id="game-title">{{title}}</div>
		<div id="game-desc">{{{desc}}}</div>
	</div>
</div>

</body>
<footer>
	<hr>
	<p>Copyright Â© 2016, Erebyte Ent., All Rights Reserved</p>
</footer>
</html>
